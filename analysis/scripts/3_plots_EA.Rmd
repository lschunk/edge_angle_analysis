---
title: "Plots - Edge angle analysis"
author: "Lisa Schunk"
date: "`r Sys.time()`"
output:
  html_document:
    df_print: paged
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

```{r Knitr Options, include=FALSE}
knitr::opts_chunk$set(comment=NA, message=FALSE, indent="", error=TRUE)

```


# Goal of the script
This script plots the data from the edge angle analysis (archaeology) in order to visualizes
the measurements.  
The plots will also visualize the differences between the three methods. 



```{r}
dir_in <- "analysis/derived_data/"
dir_out <- "analysis/plots"

```

Raw data must be located in `r paste0("~/", dir_in)`.  
Formatted data will be saved in `r paste0("~/", dir_out)`.
The knit directory for this script is the project directory.

---

# Load packages
```{r Libraries}
pack_to_load <- c("R.utils", "tools", "openxlsx", "ggplot2", "tidyverse", "patchwork", "doBy", "ggrepel")
sapply(pack_to_load, library, character.only = TRUE, logical.return = TRUE)

```


---

# Get name, path and information of the file 
```{r}
data_file <- list.files(dir_in, pattern = "\\.Rbin$", full.names = TRUE)
md5_in <- md5sum(data_file)
info_in <- data.frame(file = basename(names(md5_in)), checksum = md5_in, row.names = NULL)

```


# Load data into R object
```{r}
imp_data <- loadObject(data_file)
str(imp_data)

```

The imported file is: "`r paste0("~/", data_file)`"  


# Define numeric variables
```{r}
num.var <- 9:length(imp_data)

```


# Plot edge angle measurements 
## Plots showing the angles as lines 
```{r}

# split the data in the individual 227 samples
sp <- split(imp_data, imp_data[["ID"]])

for (j in seq_along(sp)) {
  p <- vector(mode = "list", length = length(num.var))
  names(p) <- names(sp[[j]])[num.var]

  for (i in seq_along(num.var)){ 
    p[[i]] <- ggplot(data = sp[[j]], aes_string(y = "Section",
              x = names(sp[[j]])[num.var[i]], colour = "Angle_number")) +
              geom_line(aes(group = Angle_number), orientation = "y") + 
              geom_hline(yintercept = c(2, 9), linetype = "dashed") +
              facet_wrap(~ Edge) +
              scale_colour_continuous(trans = "reverse") +
              scale_y_continuous(breaks=1:10, trans = "reverse") +
              labs(y = "Section") + 
              labs(colour = "Dis. origin (mm)") + 
              labs(x = gsub("_", " ", names(sp[[j]])[num.var[i]])) + 
              scale_x_continuous(n.breaks = 3) +
	            theme_classic() 
  }

wp <- wrap_plots(p) + plot_annotation(title = names(sp)[j]) + 
      plot_layout(guides = "collect")

print(wp)

  # save to PDF
  file_out <- paste0(file_path_sans_ext(info_in[["file"]]), "_EA_plot_", names(sp)[j],
                     ".pdf")
  ggsave(filename = file_out, plot = wp, path = dir_out, 
         device = "pdf", width = 260, height = 170, units = "mm")
}  

```



The files will be saved as "`r paste0("~/", dir_out, ".[ext]")`".


---

# sessionInfo() and RStudio version

```{r}
sessionInfo()

```

RStudio version `r readLines("analysis/scripts/RStudioVersion.txt", n = 1)`.


# Cite R packages used
```{r Citation}
for (i in pack_to_load) print(citation(i), bibtex = FALSE)

```

---

END OF SCRIPT


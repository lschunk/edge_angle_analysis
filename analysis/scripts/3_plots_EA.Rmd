---
title: "Plots - Edge angle analysis"
author: "Lisa Schunk"
date: "`r Sys.time()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cerulean
    highlight: pygments
    number_sections: true
  github_document: 
    toc: true
    toc_depth: 3
    html_preview: false
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_format = "all", 
  knit_root_dir = rprojroot::find_rstudio_root_file()) })
---

```{r Knitr Options, include=FALSE}
knitr::opts_chunk$set(comment=NA, message=FALSE, indent="", error=TRUE)
```


# Goal of the script
This script plots the data from the edge angle analysis (archaeology) in order to visualizes the measurements.  
The plots will also visualize the differences between the three methods. 



```{r}
dir_in <- "analysis/derived_data/"
dir_out <- "analysis/plots"
```

Raw data must be located in `r paste0("~/", dir_in)`.  
Formatted data will be saved in `r paste0("~/", dir_out)`.
The knit directory for this script is the project directory.

---


# Load packages
```{r}
library(R.utils)
library(ggplot2)
library(tools)
library(tidyverse)
library(patchwork)
library(doBy)
library(ggrepel)
library(openxlsx)
```


---

# Get name, path and information of the file 
```{r}
data_file <- list.files(dir_in, pattern = "\\.Rbin$", full.names = TRUE)
md5_in <- md5sum(data_file)
info_in <- data.frame(file = basename(names(md5_in)), checksum = md5_in, row.names = NULL)
```


The checksum (MD5 hashes) of the imported file is:  
```{r, echo = FALSE}
info_in
```


# Load data into R object
```{r}
#imp_data <- loadObject(data_file)
imp_data <- read.xlsx(xlsxFile = data_file, sheet = 1, startRow = 1, colNames = TRUE,
                      rowNames = FALSE, skipEmptyRows = FALSE) 
str(imp_data)
```

The imported file is: "`r paste0("~/", data_file)`"  



# Plot edge angle measurements 
## Plots showing the angles as lines 
```{r}

# splits the data in the individual 227 samples
sp <- split(imp_data, imp_data[["ID"]])


for (i in seq_along(sp)) {
  
  p1 <- ggplot(data = imp_data, aes(x = Section, y = Distance_origin, fill = Three_point)) +
        geom_point() + 
        labs(x = "Section", y = "Edge angle (degrees)") + ylab(NULL) +
	      theme_classic()
}  
print(p1)


     


# plots only the first 50 strokes per sample  
  dat_i_50 <- sp[[i]] %>% 
              # takes only the first 50 strokes per sample
              filter(Stroke %in% 1:50)
  p2 <- ggplot(data = dat_i_50) +
        geom_line(aes(x = Step, y = Depth, colour = Stroke, group = Stroke), alpha = 0.3) + 
        labs(x = "Step", y = "Depth (mm)") + 
        scale_colour_continuous(trans = "reverse") + 
        coord_cartesian(ylim = range_depth) +
        scale_x_continuous(breaks=c(1, 4, 7, 10)) +
	      theme_classic()
  # patchwork plot
  p <- p2 + p1 + plot_annotation(title = names(sp)[i]) 
  print(p)

  # save to PDF
  file_out <- paste0(file_path_sans_ext(info_in[["file"]]), 
                     "_aVSn_plot_", 
	                   names(sp)[i], ".pdf")
  ggsave(filename = file_out, plot = p, path = dir_out, 
         device = "pdf")
}  


```



## Plot showing the absolut penetration depths 
### Plot of all samples 
```{r}
# calculates the absolute depths reached per sample
abs.depth <- function(x) {
  noNA <- x[!is.na(x)]
  out <- abs(min(noNA) - max(noNA))
}

# Define grouping variable and compute the summary statistics 
depth <- summaryBy(Depth ~ Sample+Raw_material+Contact_material, 
                  data=imp_data, 
                  FUN=abs.depth)

str(depth)

# plots all depth points in one facet plot (contact material together)
p3 <- ggplot(data = depth, aes(x = Contact_material, 
                               y = Depth.abs.depth, colour = 
                                 Contact_material)) +
       geom_point() + labs(y = "Absolute depth (mm)") +
       scale_colour_hue(h = c(15,225)) +
       facet_wrap(~Raw_material, strip.position = "bottom") +
       # avoids overplotting of the labels (sample IDs)
       geom_text_repel(aes(label=Sample), size = 2, 
                       nudge_x = -0.4, 
                       segment.size = 0.1, force = 2, 
                       seed = 123) +
       scale_y_continuous(trans = "reverse") +
       scale_x_discrete(position="top") +
       # removes the "_" between "Contact_material in the legend 
       labs(x = "Contact material") + 
	     theme_classic() +
       theme(legend.position = "none") 
      
print(p3)

# save to PDF
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), 
                   "_aVSn_P3_depth_plot_", ".pdf")
ggsave(filename = file_out, plot = p3, path = dir_out, 
       device = "pdf", 
       width = 25, height = 17, units = "cm")


# plots all depth points in one facet plot (contact material separated)
p4 <- ggplot(data = depth, aes(x = Contact_material, 
                               y = Depth.abs.depth, colour = 
                                 Raw_material)) +
       geom_point() + labs(y = "Absolute depth (mm)") +
       scale_colour_hue(h = c(15,225)) +
       facet_wrap(~Contact_material, strip.position = "bottom") +
       # avoids overplotting of the labels (sample IDs)
       geom_text_repel(aes(label=Sample), size = 2, 
                       nudge_x = -0.4, 
                       segment.size = 0.1, force = 2, 
                       seed = 123) +
       scale_y_continuous(trans = "reverse") +
       scale_x_discrete(position="top") +
       # removes the "_" between "Contact_material in the legend 
       labs(x = "Contact material") + 
	     theme_classic() +
       theme(axis.text.x = element_blank(), axis.ticks = element_blank()) +
       theme(legend.position = "none") 
      
print(p4)

# save to PDF
file_out <- paste0(file_path_sans_ext(info_in[["file"]]), 
                   "_aVSn_P4_depth_plot_", ".pdf")
ggsave(filename = file_out, plot = p4, path = dir_out, 
       device = "pdf", 
       width = 25, height = 17, units = "cm")



```


The files will be saved as "`r paste0("~/", dir_out, ".[ext]")`".

---
# Save data
## Write to XLSX (summary statistics)
```{r}
write.xlsx(list(depth = depth, depth_good = depth_good), 
           file = paste0(dir_out, file_out, ".xlsx"))
```


---


# Show plot files information
```{r}
info_out <- list.files(path = dir_out, pattern = "\\.pdf$", 
                       full.names = TRUE) %>% 
            md5sum()
```


The checksum (MD5 hashes) of the exported files are:  
```{r, echo = FALSE}
info_out
```



---

# sessionInfo() and RStudio version

```{r}
sessionInfo()
```

RStudio version `r readLines("analysis/scripts/RStudioVersion.txt", n = 1)`.


---

END OF SCRIPT

